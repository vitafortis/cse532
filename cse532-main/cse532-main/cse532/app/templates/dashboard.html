<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vuln API — Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background:#0f172a; color:#e2e8f0; }
    .card { background:#111827; border:1px solid #1f2937; }
    .card h5, .card .card-title { color:#f8fafc; }
    .muted { color:#9ca3af; }
    .kpi { font-size:1.6rem; font-weight:700; }
    .small-label { font-size:.85rem; text-transform:uppercase; letter-spacing:.06em; color:#9ca3af;}
    .table td, .table th { color:#e5e7eb; border-color:#1f2937; }
    .btn-primary { background:#2563eb; border:none; }
    .btn-primary:hover { background:#1d4ed8; }
    .btn-secondary { background:#4b5563; border:none; }
    .btn-secondary:hover { background:#374151; }
    .chart-wrap { padding:1rem; background:#0b1220; border:1px solid #1f2937; border-radius:.5rem; }
    .toolbar { gap:.5rem; }
  </style>
</head>

<body>
  <div class="container py-4">
    <!-- Header + Run buttons -->
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
      <h2 class="mb-0">Analytics Dashboard</h2>
      <div class="d-flex flex-wrap toolbar">
        <button id="summaryBtn" class="btn btn-secondary">Run Summary</button>
        <button id="allBtn" class="btn btn-primary">Run Full Analytics</button>
        <button id="packageBtn" class="btn btn-warning text-dark">Run Package Check</button>
        <button id="sbomBtn" class="btn btn-success">Run SBOM Check</button>
        <button id="exportRecentBtn" class="btn btn-outline-light">Export Recent CSV</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="small-label">Total Requests</div>
          <div id="kpi-requests" class="kpi">—</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="small-label">Total Packages Processed</div>
          <div id="kpi-packages" class="kpi">—</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="small-label">Total Vulnerabilities Recorded</div>
          <div id="kpi-vulns" class="kpi">—</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="small-label">Latest Request (UTC)</div>
          <div id="kpi-latest" class="kpi" style="font-size:1rem;">—</div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
          <h5 class="card-title mb-2">Top Packages (by requests)</h5>
          <div class="chart-wrap">
            <canvas id="topPackagesChart" height="220"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
          <h5 class="card-title mb-2">Endpoint Usage</h5>
          <div class="chart-wrap">
            <canvas id="endpointChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card p-3">
          <h5 class="card-title mb-2">Vulnerabilities Over Recent Requests</h5>
          <div class="muted mb-2">Shows vulnerabilities per request (from recent activity).</div>
          <div class="chart-wrap">
            <canvas id="vulnsOverTimeChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Vulnerabilities by Package (Filtered) -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <h5 class="card-title mb-2">Vulnerabilities by Package (Filtered)</h5>
            <div class="d-flex align-items-center gap-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="modeToggle">
                <label class="form-check-label" for="modeToggle"><span id="modeLabel">Live Scan</span></label>
              </div>
              <label class="small-label mb-0">Last:</label>
              <select id="vulnDays" class="form-select form-select-sm" style="width:120px;">
                <option value="7">7 days</option>
                <option value="30" selected>30 days</option>
                <option value="90">90 days</option>
                <option value="365">365 days</option>
              </select>
              <button id="vulnByPackageBtn" class="btn btn-sm btn-primary">Run</button>
              <button id="exportVulnsBtn" class="btn btn-sm btn-outline-light">Export CSV</button>
            </div>
          </div>
          <div class="muted mb-2">Mode: <strong id="modeCaption">Live (queries OSV now)</strong> • <span class="muted">Last updated:</span> <span id="vulnUpdated">—</span></div>
          <div class="chart-wrap">
            <canvas id="vulnsByPackageChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Package Statistics Table -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card p-3">
          <h5 class="card-title mb-2">Package Statistics</h5>
          <div class="muted mb-2">Shows tracked packages, total request counts, and cumulative vulnerabilities recorded.</div>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
              <thead>
                <tr>
                  <th>Package</th>
                  <th>Ecosystem</th>
                  <th>Times Requested</th>
                  <th>Total Vulns Recorded</th>
                  <th>Last Requested</th>
                </tr>
              </thead>
              <tbody id="packageStatsBody">
                <tr><td colspan="5" class="text-center muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="muted">Data sourced from <code>/api/v1/debug/packages</code>.</div>
        </div>
      </div>
    </div>

    <!-- Recent Requests Table -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card p-3">
          <h5 class="card-title mb-2">Recent Requests</h5>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
              <thead>
                <tr>
                  <th>Timestamp (UTC)</th>
                  <th>Endpoint</th>
                  <th>Client IP</th>
                  <th>Packages</th>
                  <th>Vulns</th>
                </tr>
              </thead>
              <tbody id="recentTableBody">
                <tr><td colspan="5" class="text-center muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="muted">Data sourced from <code>/api/v1/stats/all</code>.</div>
        </div>
      </div>
    </div>
  </div> <!-- /container -->

  <!-- Toast container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body" id="toastMsg">Ready.</div>
    </div>
  </div>

  <!-- Bootstrap JS (for toasts) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // ---------- constants / state ----------
    const KNOWN_PKGS = ["flask", "requests", "numpy", "django", "fastapi", "sqlalchemy"];
    let topPackagesChart, endpointChart, vulnsOverTimeChart;
    let vulnsByPackageChart = null;
    let recentCache = [];           // for export
    let lastVulnsDataset = [];      // for export

    // ---------- helpers ----------
    function toast(msg) {
      const t = document.getElementById("toast");
      document.getElementById("toastMsg").textContent = msg;
      const toast = new bootstrap.Toast(t, { delay: 1800 });
      toast.show();
    }

    function makeBarChart(canvas, labels, values, title) {
      const ctx = canvas.getContext("2d");
      return new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: title, data: values }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#e5e7eb" }, grid: { color: "#1f2937" } },
            y: { ticks: { color: "#e5e7eb" }, grid: { color: "#1f2937" } }
          }
        }
      });
    }

    function makeLineChart(canvas, labels, values, title) {
      const ctx = canvas.getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: title, data: values, tension: 0.25 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#e5e7eb" }, grid: { color: "#1f2937" } },
            y: { ticks: { color: "#e5e7eb" }, grid: { color: "#1f2937" } }
          }
        }
      });
    }

    // ---------- data loaders (summary/all) ----------
    async function loadSummary() {
      try {
        const res = await fetch("/api/v1/stats/summary");
        const s = await res.json();
        document.getElementById("kpi-requests").textContent = s.total_requests ?? "—";
        document.getElementById("kpi-packages").textContent = s.total_packages_processed ?? "—";
        document.getElementById("kpi-vulns").textContent = s.total_vulnerabilities_recorded ?? "—";
        document.getElementById("kpi-latest").textContent = s.latest_request || "—";
        toast("Summary refreshed");
      } catch {
        toast("Failed to load summary");
      }
    }

    async function loadAll() {
      try {
        const res = await fetch("/api/v1/stats/all");
        const data = await res.json();

        // KPIs
        const s = data.summary || {};
        document.getElementById("kpi-requests").textContent = s.total_requests ?? "—";
        document.getElementById("kpi-packages").textContent = s.total_packages ?? "—";
        document.getElementById("kpi-vulns").textContent = s.total_vulnerabilities ?? "—";
        document.getElementById("kpi-latest").textContent = s.latest_request || "—";

        // Top packages
        const top = (data.top_packages || []).slice(0, 10);
        const pkgLabels = top.map(p => p.package);
        const pkgCounts = top.map(p => p.times_requested);
        if (topPackagesChart) topPackagesChart.destroy();
        topPackagesChart = makeBarChart(document.getElementById("topPackagesChart"), pkgLabels, pkgCounts, "Requests");

        // Endpoint usage
        const eps = data.endpoint_stats || [];
        const epLabels = eps.map(e => e.endpoint);
        const epCounts = eps.map(e => e.requests);
        if (endpointChart) endpointChart.destroy();
        endpointChart = makeBarChart(document.getElementById("endpointChart"), epLabels, epCounts, "Requests per Endpoint");

        // Recent activity -> line
        const recent = data.recent_activity || [];
        recentCache = recent; // keep for export
        const rLabels = recent.map(r => r.timestamp);
        const rVulns = recent.map(r => r.vulns);
        if (vulnsOverTimeChart) vulnsOverTimeChart.destroy();
        vulnsOverTimeChart = makeLineChart(document.getElementById("vulnsOverTimeChart"), rLabels, rVulns, "Vulns per Request");

        // Recent table
        const tbody = document.getElementById("recentTableBody");
        tbody.innerHTML = "";
        if (recent.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center muted">No recent activity.</td></tr>`;
        } else {
          for (const r of recent) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="muted">${r.timestamp}</td>
              <td><code>${r.endpoint}</code></td>
              <td>${r.ip || r.client_ip || "-"}</td>
              <td>${r.packages}</td>
              <td>${r.vulns}</td>
            `;
            tbody.appendChild(tr);
          }
        }

        toast("Full analytics loaded");
      } catch (e) {
        console.error(e);
        toast("Failed to load analytics");
      }
    }

    // ---------- vulnerabilities by package (live vs historical) ----------
    function updateVulnMeta(updatedWhen, modeText) {
      document.getElementById("vulnUpdated").textContent = updatedWhen;
      document.getElementById("modeCaption").textContent = modeText;
    }

    async function loadVulnsByPackageLive(days) {
      // Build SBOM with known pkgs (latest)
      const sbom = KNOWN_PKGS.map(p => `${p}@latest`).join(", ");
      const body = { sbom, ecosystem: "PyPI", days: parseInt(days) };

      const res = await fetch("/api/v1/vulns/by-sbom", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();

      // Count per known package from returned details (fallback to 0)
      const grouped = Object.fromEntries(KNOWN_PKGS.map(p => [p, 0]));
      if (Array.isArray(data.vulnerabilities)) {
        for (const v of data.vulnerabilities) {
          let match = null;
          if (v.package && grouped.hasOwnProperty(v.package.toLowerCase())) {
            match = v.package.toLowerCase();
          } else if (Array.isArray(v.references)) {
            for (const ref of v.references) {
              for (const p of KNOWN_PKGS) {
                if (ref.url && ref.url.toLowerCase().includes(p)) { match = p; break; }
              }
              if (match) break;
            }
          }
          if (match) grouped[match] += 1;
        }
      }

      const labels = Object.keys(grouped);
      const counts = Object.values(grouped);
      lastVulnsDataset = labels.map((label, i) => ({ package: label, count: counts[i] }));

      if (vulnsByPackageChart) vulnsByPackageChart.destroy();
      vulnsByPackageChart = makeBarChart(document.getElementById("vulnsByPackageChart"), labels, counts, `Vulnerabilities by Package (last ${days} days)`);

      updateVulnMeta(new Date().toISOString(), "Live (queries OSV now)");
      toast("Live vulnerability scan complete");
    }

    async function loadVulnsByPackageHistorical(days) {
      // Try to derive from stored stats; if not granular, fallback to live
      const res = await fetch("/api/v1/stats/all");
      const data = await res.json();
      const recent = Array.isArray(data.recent_activity) ? data.recent_activity : [];

      // Filter by days if timestamps are ISO strings
      const cutoff = Date.now() - (parseInt(days) * 24 * 60 * 60 * 1000);
      const filtered = recent.filter(r => {
        const t = Date.parse(r.timestamp);
        return isFinite(t) ? t >= cutoff : true;
      });

      // If your backend includes per-package info in recent_activity (e.g., r.package_name),
      // aggregate here. Your current payload doesn’t, so this will be empty:
      const grouped = Object.fromEntries(KNOWN_PKGS.map(p => [p, 0]));
      let hasPerPackage = false;

      for (const r of filtered) {
        // Example if you later add r.package field:
        // if (r.package && grouped.hasOwnProperty(r.package.toLowerCase())) {
        //   grouped[r.package.toLowerCase()] += r.vulns || 0;
        //   hasPerPackage = true;
        // }
      }

      if (!hasPerPackage) {
        // Fallback to Live to keep UX useful
        await loadVulnsByPackageLive(days);
        updateVulnMeta(new Date().toISOString(), "Historical (fallback to Live due to missing per-package in stats)");
        return;
      }

      const labels = Object.keys(grouped);
      const counts = Object.values(grouped);
      lastVulnsDataset = labels.map((label, i) => ({ package: label, count: counts[i] }));

      if (vulnsByPackageChart) vulnsByPackageChart.destroy();
      vulnsByPackageChart = makeBarChart(document.getElementById("vulnsByPackageChart"), labels, counts, `Vulnerabilities by Package (last ${days} days)`);

      updateVulnMeta(new Date().toISOString(), "Historical (from stored stats)");
      toast("Historical vulnerabilities loaded");
    }

    async function runVulnChart() {
      const days = document.getElementById("vulnDays").value;
      const live = !document.getElementById("modeToggle").checked; // OFF = Live, ON = Historical
      document.getElementById("modeLabel").textContent = live ? "Live Scan" : "Historical Data";

      if (live) {
        await loadVulnsByPackageLive(days);
      } else {
        await loadVulnsByPackageHistorical(days);
      }
    }

    // ---------- vulnerability triggers (manual actions) ----------
    async function runPackageCheck() {
      const pkg = prompt("Enter a package name (e.g., flask):", "flask");
      const days = prompt("Enter number of days to check (default 365):", "365");
      if (!pkg) return;
      try {
        const res = await fetch("/api/v1/vulns/by-package", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ package: pkg, ecosystem: "PyPI", days: parseInt(days) })
        });
        const data = await res.json();
        toast(`Found ${data.count || 0} vulnerabilities for ${data.package || pkg}`);
        loadAll();
      } catch {
        toast("Package check failed");
      }
    }

    async function runSBOMCheck() {
      const sbom = prompt(
        "Enter comma-separated packages with versions (e.g., flask@2.2.5, requests@2.31.0, numpy@1.26.4):",
        "flask@2.2.5, requests@2.31.0, numpy@1.26.4"
      );
      if (!sbom) return;
      try {
        const res = await fetch("/api/v1/vulns/by-sbom", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sbom, ecosystem: "PyPI" })
        });
        const data = await res.json();
        toast(`SBOM scan complete — ${data.total_vulnerabilities || 0} vulnerabilities`);
        loadAll();
      } catch {
        toast("SBOM check failed");
      }
    }

    // ---------- CSV exports ----------
    function downloadCSV(filename, rows) {
      const csv = [
        Object.keys(rows[0]).join(","),
        ...rows.map(r => Object.values(r).map(v => `"${String(v).replace(/"/g, '""')}"`).join(","))
      ].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportRecentCSV() {
      if (!recentCache || recentCache.length === 0) {
        toast("No recent activity to export");
        return;
      }
      downloadCSV("recent_requests.csv", recentCache);
    }

    function exportVulnsCSV() {
      if (!lastVulnsDataset || lastVulnsDataset.length === 0) {
        toast("No vulnerability dataset to export");
        return;
      }
      downloadCSV("vulns_by_package.csv", lastVulnsDataset);
    }

    // ---------- package statistics table ----------
    async function loadPackageStats() {
      try {
        const res = await fetch("/api/v1/debug/packages");
        const data = await res.json();

        const tbody = document.getElementById("packageStatsBody");
        tbody.innerHTML = "";

        if (!data.packages || data.packages.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center muted">No data available.</td></tr>`;
          return;
        }

        data.packages.forEach(pkg => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${pkg.package}</td>
            <td>${pkg.ecosystem}</td>
            <td>${pkg.times_requested}</td>
            <td>${pkg.total_vulns_recorded}</td>
            <td>${pkg.last_requested_at ? new Date(pkg.last_requested_at).toLocaleString() : "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Failed to load package stats:", err);
        const tbody = document.getElementById("packageStatsBody");
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>`;
      }
    }

    // ---------- wire up events ----------
    document.getElementById("summaryBtn").addEventListener("click", loadSummary);
    document.getElementById("allBtn").addEventListener("click", loadAll);
    document.getElementById("packageBtn").addEventListener("click", runPackageCheck);
    document.getElementById("sbomBtn").addEventListener("click", runSBOMCheck);
    document.getElementById("vulnByPackageBtn").addEventListener("click", runVulnChart);
    document.getElementById("modeToggle").addEventListener("change", runVulnChart);
    document.getElementById("exportRecentBtn").addEventListener("click", exportRecentCSV);
    document.getElementById("exportVulnsBtn").addEventListener("click", exportVulnsCSV);

    // ---------- initial load ----------
    loadAll();
    runVulnChart();
    loadPackageStats();
  });
  </script>
</body>
</html>
